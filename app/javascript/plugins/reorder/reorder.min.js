ArticleEditor,ArticleEditor.add("plugin","reorder",{defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m3 5h10c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1h-10c-.55228475 0-1-.44771525-1-1s.44771525-1 1-1zm0 4h10c.5522847 0 1 .44771525 1 1 0 .5522847-.4477153 1-1 1h-10c-.55228475 0-1-.4477153-1-1 0-.55228475.44771525-1 1-1z" fill-rule="evenodd"/></svg>'},subscribe:{"block.set":function(){this._observe()}},init:function(){this.utils=this.app.create("utils")},start:function(){this.app.control.add("reorder",{icon:this.opts.reorder.icon,position:"first",blocks:"first-level"})},stop:function(){this.$btn.off(".arx-reorder-"+this.uuid),this.app.$win.off(".arx-reorder-"+this.uuid)},_observe:function(){this.$btn=this.app.control.get("reorder"),this.$btn.addClass("arx-handle"),this._sortable()},_sortable:function(){this.$scrollTarget=this.utils.isScrollTarget()?this.utils.getScrollTarget():this.app.$win,this.tolerance=this.$btn.width(),this.$clickItem=null,this.$dragItem=null,this.click={},this.dragging=!1,this.$btn.on("mousedown.arx-reorder-"+this.uuid+" touchstart.arx-reorder-"+this.uuid,this._press.bind(this)),this.app.$win.on("mouseup.arx-reorder-"+this.uuid+" touchend.arx-reorder-"+this.uuid,this._release.bind(this)),this.app.$win.on("mousemove.arx-reorder-"+this.uuid+" touchmove.arx-reorder-"+this.uuid,this._move.bind(this))},_getPoint:function(t,i){return i?{x:t.clientX+this.tolerance,y:t.clientY}:{x:t.pageX+this.tolerance,y:t.pageY}},_isOver:function(t,i,e){var s=t.offset(),r=t.width(),o=t.height(),a=i>s.left&&i<s.left+r,h=e>s.top&&e<s.top+o;return a&&h},_swapItems:function(t,i){var e=(t=t.get()).parentNode,s=i.parentNode;if(e!==s)s.insertBefore(t,i);else{var r=document.createElement("div");e.insertBefore(r,t),s.insertBefore(t,i),e.insertBefore(i,r),e.removeChild(r)}},_moveItem:function(t,i,e){t.css("transform","translateY("+e+"px)")},_makeDragItem:function(t){this._trashDragItem();var i=this.dom(t);this.$clickItem=i,this.$clickItem.addClass("arx-active");var e=i.clone();e.removeClass("arx-active arx-block-focus"),this.$dragItem=this.dom("<div>"),this.$dragItem.append(e),this.$dragItem.addClass("arx-dragging"),this.$dragItem.css({opacity:.95,position:"absolute","z-index":999,left:(t.offsetLeft||0)+"px",top:(t.offsetTop||0)+"px",width:(t.offsetWidth||0)+"px"}),this.app.editor.$editor.append(this.$dragItem)},_trashDragItem:function(){this.$dragItem&&this.$clickItem&&(this.$clickItem.removeClass("arx-active arx-block-focus"),this.$clickItem=null,this.$dragItem.remove(),this.$dragItem=null)},_press:function(t){var i=this.dom(t.target).closest(".arx-button");if(t&&t.target&&i.hasClass("arx-handle")){t.preventDefault();var e=this.app.block.get().$block.get();this.app.block.unset(),this.dragging=!0,this.click=this._getPoint(t),this._makeDragItem(e,t.target),this.dragTop=this.$dragItem.offset().top,this._move(t)}},_release:function(t){this.dragging=!1,this.app.observer.trigger=!0,this._trashDragItem()},_scroll:function(t){var i=this.utils.isScrollTarget()?this.$scrollTarget:this.app.$win,e=i.scrollTop();i.scrollTop(e+t)},_getBox:function(t,i){var e=(this.utils.isScrollTarget()&&!1!==i?t.position():t.offset()).top;return{start:e,end:e+t.height()}},_move:function(t){if(this.$dragItem||this.dragging){t.preventDefault(),this.app.observer.trigger=!1;var i=this._getPoint(t),e={x:i.x-this.click.x,y:i.y-this.click.y};if(0!==e.x&&0!==e.y){if(this._moveItem(this.$dragItem,e.x,e.y),!this.utils.isScrollTarget()){var s=this.app.editor.$editor,r=this.app.$win,o=this._getBox(s),a=r.scrollTop(),h=this.app.editor.$editor.offset().top,n=t.clientY+r.scrollTop(),l=(r.height(),r.scrollTop(),"down");this.dragTop-this.$dragItem.offset().top<50?t.clientY>r.height()-50&&n<o.end&&this._scroll(10):this.dragTop-this.$dragItem.offset().top>50&&(l="up",t.clientY<50&&t.clientY+a>h&&this._scroll(-10))}var d=this.app.editor.$editor.get().children.length;if(this._isOver(this.app.editor.$editor,i.x,i.y)&&0===d){var c="up"===l?"prepend":"append";this.app.editor.$editor[c](this.$clickItem)}else for(var p=0;p<d;p++){var g=this.app.editor.$editor.get().children[p];"SCRIPT"!==g.tagName&&g!==this.$clickItem.get()&&g!==this.$dragItem.get()&&this._isOver(this.dom(g),i.x,i.y)&&this._swapItems(this.$clickItem,g)}}}}});